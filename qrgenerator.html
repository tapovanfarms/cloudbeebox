<!DOCTYPE html>
<html>
    <head>
        <title>QR Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
        <script src="https://api.trello.com/1/client.js?key=aa5c6d871d68ef0b66857ef2bb7a2ba5"></script>
        <script src="./js/qrcode.min.js"></script>
        <style>
            body {
                font-size: 1.5em;
            }
            .navbar {
                position:sticky; 
                top:0; 
                background-color:#4CAF50;
                color:white; 
                padding:10px;
            }
            button {
                background-color: #4CAF50; /* Green */
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                width: 300px;
                margin-top: 10px;
            }
        </style>
    </head>
    <body style="margin:0px">
        <div class="navbar">
            <img style="display:block; height:3em; margin:auto" src="img/cloudbeebox.png">
        </div>
        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
            <div style="margin:10px">
                <u><div id="qrname" style="max-width:100%; text-align:center">QR Generator</div></u>
                <div id="qrcode" style="min-height: 300px; background-color:#eee;"></div>
                <div style="max-width:100%; margin-top:10px; text-align:center"><a id="qrlink">...</a></div>
                <button onclick="generateQR()">Generate QR</button>
            </div>
            <div style="margin:10px; border: solid 1px #eee;">
                <label for="listName">Select a beebox and click the button:</label><br/>
                <div id="listContainer" style="margin-top:10px"></div>
            </div>
        </div>

        <script type="text/javascript">
            var lists = [];
            var qrcode = null;
            function selectItem(event) {
                console.dir(event);
            }
            function renderLists() {
                var html = "";
                for (var i = 0; i < lists.length; i++) {
                    var tag = "<input type='radio' name='listName' value='" + i + "' id='" + i + "'><label for='" + i + "'>" + lists[i]['name'] + "</label><br/>";
                    html += tag;
                }
                document.getElementById("listContainer").innerHTML = html;
            }
            function urlBuilder(beekeeperName, listName, listId) {
                let BASE_URL = "https://tapovanfarms.github.io/cloudbeebox/gototrello.html";
                let UTM_SRC = "?utm_source=" + listName.toLowerCase();
                let UTM_MED = "&utm_medium=boxqr";
                let UTM_CAMPAIGN = "&utm_campaign=" + beekeeperName.toLowerCase();
                let USER_ID = "&userId=" + listId;
                return BASE_URL + UTM_SRC + UTM_MED + UTM_CAMPAIGN + USER_ID;
            }
            function generateQR() {
                listNames = document.getElementsByName('listName');
                var selectedIdx = -1;
                for (const listName of listNames) {
                    if (listName.checked) {
                        selectedIdx = parseInt(listName.value);
                        break;
                    }
                }
                if (selectedIdx == -1) {
                    console.log("Nothing selected...")
                    return;
                } 
                var item = lists[selectedIdx];
                // if (qrcode) {
                //     qrcode.clear();
                // }
                document.getElementById('qrcode').innerHTML = "";
                qrcode = new QRCode("qrcode", {
                    text: urlBuilder('radhesh', item['name'], item['id']),
                    width: 300,
                    height: 300,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                //set name
                document.getElementById('qrname').innerText = item['name'];
                //set download link
                var cnvs = document.getElementById('qrcode').getElementsByTagName('canvas');
                var link = document.getElementById('qrlink');
                link.download = item['name'] + '.png';
                link.href = cnvs[0].toDataURL("image/png");
                link.innerText = 'Download';
            }
            // process lists
            var forList = function(item) {
                if (item['closed']) {
                    return;
                }
                else {
                    // console.log(item['name'], item['id']);
                    lists.push(item);
                }
            };
            // LIST api handlers
            var listsSuccess = function(data) {
                console.log("Lists received");
                data.forEach(forList);
                renderLists();
            };
            var listsFailure = function() {
                console.log("Lists failed");
            };
            // process boards
            var forBoard = function(item) {
                if (item['closed']) {
                    return;
                }
                else {
                    console.log('Getting lists from', item['name'], item['id']);
                    window.Trello.get('/boards/' + item['id'] + '/lists', listsSuccess, listsFailure);
                }
            };
            // BOARD api handlers
            var boardsSuccess = function(data) {
                console.log('Boards received.');
                data.map(forBoard);
            };
            var boardsFailure = function() {
                console.log('Boards failed');
            };
            // AUTH api handlers   
            var authenticationSuccess = function() {
                console.log('Successful authentication. Getting boards...');
                window.Trello.get('/members/me/boards', boardsSuccess, boardsFailure);
            };
            var authenticationFailure = function() {
                console.log('Failed authentication');
            };
            // Start auth flow
            window.Trello.authorize({
                type: 'redirect',
                name: 'Cloud Beebox',
                scope: {read: 'true', write: 'false'},
                expiration: 'never',
                success: authenticationSuccess,
                error: authenticationFailure
            });
        </script>
    </body>
</html>